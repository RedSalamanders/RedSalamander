name: Build (reusable)

"on":
  workflow_call:
    inputs:
      configuration:
        type: string
        default: Release
      platform:
        type: string
        default: x64
      upload_build_output:
        type: boolean
        default: false

jobs:
  build:
    runs-on: windows-latest
    env:
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      VCPKG_INSTALLED_DIR: ${{ github.workspace }}\.build\vcpkg_installed
      VCPKG_DEFAULT_TRIPLET: ${{ inputs.platform == 'ARM64' && 'arm64-windows' || 'x64-windows' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── Setup toolchain ──────────────────────────────────────────────

      - name: Install VS 2026 Build Tools + VC++ workload
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          choco install visualstudio2026buildtools -y --no-progress
          if ($LASTEXITCODE -notin 0,3010) { throw "VS Build Tools install failed: $LASTEXITCODE" }
          choco install visualstudio2026-workload-vctools -y --no-progress
          if ($LASTEXITCODE -notin 0,3010) { throw "VC workload install failed: $LASTEXITCODE" }

      - name: Select MSBuild (VS 2026)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vswhere)) {
            throw "vswhere.exe not found: $vswhere"
          }

          $msbuild =
            (& $vswhere -latest -products * -prerelease -version '[18.0,19.0)' -find 'MSBuild\Current\Bin\MSBuild.exe' 2>$null) |
            Select-Object -First 1

          if (-not $msbuild) {
            $msbuild =
              (& $vswhere -latest -products * -prerelease -version '[18.0,19.0)' -find 'MSBuild\Current\Bin\amd64\MSBuild.exe' 2>$null) |
              Select-Object -First 1
          }

          if (-not $msbuild -or -not (Test-Path $msbuild)) {
            Write-Host "Installed Visual Studio instances:" -ForegroundColor Yellow
            & $vswhere -all -prerelease -products *
            throw "MSBuild for Visual Studio 2026 (18.x) not found after installation."
          }

          $msbuildDir = Split-Path -Parent $msbuild
          $msbuildDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "MSBUILD_EXE_PATH=$msbuild" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          & $msbuild -version

      # ── Restore dependencies ─────────────────────────────────────────

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            .build/vcpkg_installed
            vcpkg/downloads
          key: ${{ runner.os }}-vcpkg-${{ env.VCPKG_DEFAULT_TRIPLET }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}

      - name: Bootstrap vcpkg
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $manifestPath = Join-Path $env:GITHUB_WORKSPACE "vcpkg.json"
          if (-not (Test-Path $manifestPath)) {
            throw "vcpkg.json not found at: $manifestPath"
          }

          $baseline = (Get-Content -Path $manifestPath -Raw | ConvertFrom-Json)."builtin-baseline"
          if ([string]::IsNullOrWhiteSpace($baseline)) {
            throw "vcpkg.json builtin-baseline is missing/empty. Set builtin-baseline to a valid vcpkg commit."
          }

          $baseline = $baseline.Trim()
          if ($baseline -notmatch '^[0-9a-fA-F]{40}$') {
            throw "vcpkg.json builtin-baseline is not a 40-character commit SHA: '$baseline'"
          }

          $baseline = $baseline.ToLowerInvariant()
          Write-Host "vcpkg builtin-baseline: $baseline"

          # Cache may restore vcpkg\downloads without the vcpkg repo itself.
          $bootstrap = Join-Path $env:GITHUB_WORKSPACE "vcpkg\\bootstrap-vcpkg.bat"
          $gitDir = Join-Path $env:GITHUB_WORKSPACE "vcpkg\\.git"
          if (-not (Test-Path $bootstrap) -or -not (Test-Path $gitDir)) {
            $downloads = Join-Path $env:GITHUB_WORKSPACE "vcpkg\\downloads"
            $downloadsStash = $null

            if (Test-Path $downloads) {
              $downloadsStash = Join-Path $env:RUNNER_TEMP "vcpkg-downloads"
              if (Test-Path $downloadsStash) { Remove-Item $downloadsStash -Recurse -Force }
              Move-Item -Path $downloads -Destination $downloadsStash
            }

            if (Test-Path .\\vcpkg) { Remove-Item .\\vcpkg -Recurse -Force }
            git clone https://github.com/microsoft/vcpkg .\\vcpkg
            if ($LASTEXITCODE -ne 0) { throw "git clone vcpkg failed with exit code $LASTEXITCODE" }

            if ($downloadsStash) {
              if (Test-Path $downloads) { Remove-Item $downloads -Recurse -Force }
              Move-Item -Path $downloadsStash -Destination $downloads
            }
          }

          Push-Location .\\vcpkg

          # vcpkg port versioning needs git objects that are typically missing in shallow clones.
          # Unshallow to avoid "failed to unpack tree object" during `vcpkg install`.
          $isShallow = (git rev-parse --is-shallow-repository).Trim()
          if ($isShallow -eq "true") {
            Write-Host "vcpkg repo is shallow; fetching full history..."
            git fetch --prune --unshallow origin
            if ($LASTEXITCODE -ne 0) {
              throw "git fetch --unshallow failed (exit code $LASTEXITCODE)."
            }
          }

          # Ensure the pinned baseline commit exists locally; shallow clones won't include it.
          git cat-file -e "$baseline^{commit}" 2>$null
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Fetching vcpkg baseline commit..."

            git fetch --depth 1 origin $baseline
            if ($LASTEXITCODE -ne 0) {
              $isShallow = (git rev-parse --is-shallow-repository).Trim()
              if ($isShallow -eq "true") {
                git fetch --prune --unshallow origin
              } else {
                git fetch --prune origin
              }

              if ($LASTEXITCODE -ne 0) {
                throw "git fetch failed while trying to obtain vcpkg baseline commit '$baseline' (exit code $LASTEXITCODE)."
              }
            }

            git cat-file -e "$baseline^{commit}" 2>$null
            if ($LASTEXITCODE -ne 0) {
              throw "vcpkg baseline commit not found after fetch: $baseline"
            }
          }

          # Fail fast with a clear message if the manifest pins an unsupported baseline commit.
          git show "${baseline}:versions/baseline.json" 1>$null 2>$null
          if ($LASTEXITCODE -ne 0) {
            throw "vcpkg.json builtin-baseline '$baseline' is invalid: versions/baseline.json missing at that commit. Update vcpkg.json builtin-baseline."
          }

          Pop-Location

          & $bootstrap
          if ($LASTEXITCODE -ne 0) { throw "bootstrap-vcpkg.bat failed with exit code $LASTEXITCODE" }

      - name: Install dependencies
        shell: pwsh
        run: |
          .\vcpkg\vcpkg.exe install --triplet $env:VCPKG_DEFAULT_TRIPLET --x-manifest-root $env:GITHUB_WORKSPACE --x-install-root "$env:GITHUB_WORKSPACE\.build\vcpkg_installed"

      - name: Enable vcpkg MSBuild integration
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          .\vcpkg\vcpkg.exe integrate install

      - name: Normalize vcpkg install root
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $triplet = $env:VCPKG_DEFAULT_TRIPLET
          $dest = Join-Path $env:GITHUB_WORKSPACE ".build\vcpkg_installed\$triplet"
          $expected = Join-Path $dest "include\wil\com.h"
          if (Test-Path $expected) {
            Write-Host ".build\vcpkg_installed\$triplet already contains WIL headers."
            exit 0
          }

          $candidates = @(
            (Join-Path $env:GITHUB_WORKSPACE "vcpkg\installed\$triplet"),
            (Join-Path $env:GITHUB_WORKSPACE "vcpkg\installed\${triplet}-release")
          )

          $source = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $source) {
            Write-Host "Expected WIL header not found at: $expected" -ForegroundColor Yellow
            Write-Host "Searched install roots:" -ForegroundColor Yellow
            $candidates | ForEach-Object { Write-Host "  - $_" }
            Write-Host ".build\vcpkg_installed contents:" -ForegroundColor Yellow
            Get-ChildItem -Path (Join-Path $env:GITHUB_WORKSPACE ".build\vcpkg_installed") -ErrorAction SilentlyContinue | Select-Object Name
            Write-Host "vcpkg contents:" -ForegroundColor Yellow
            Get-ChildItem -Path (Join-Path $env:GITHUB_WORKSPACE "vcpkg") -ErrorAction SilentlyContinue | Select-Object Name
            throw "vcpkg install root not found to normalize."
          }

          Write-Host "Syncing $source -> $dest"
          New-Item -ItemType Directory -Path $dest -Force | Out-Null
          & robocopy.exe $source $dest /E /R:1 /W:1 /NFL /NDL /NJH /NJS /NP | Out-Null
          if ($LASTEXITCODE -ge 8) {
            throw "robocopy failed with exit code $LASTEXITCODE"
          }

          if (-not (Test-Path $expected)) {
            throw "Expected WIL header not found after sync: $expected"
          }

      # ── Build ────────────────────────────────────────────────────────

      - name: Build solution
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # CI runners don't always include Visual Studio's vcpkg MSBuild integration component.
          # Provide vcpkg include/lib paths explicitly so compilation and linking can resolve dependencies.
          $triplet = $env:VCPKG_DEFAULT_TRIPLET
          $vcpkgRoot = Join-Path $env:GITHUB_WORKSPACE ".build\vcpkg_installed\$triplet"
          $incRoot = Join-Path $vcpkgRoot "include"
          $libRoot = Join-Path $vcpkgRoot "lib"
          $binRoot = Join-Path $vcpkgRoot "bin"

          if (-not (Test-Path $incRoot)) { throw "vcpkg include root not found: $incRoot" }
          if (-not (Test-Path $libRoot)) { throw "vcpkg lib root not found: $libRoot" }

          $env:CL = "/I`"$incRoot`" $env:CL"

          $linkPaths = @($libRoot)
          $libManualRoot = Join-Path $libRoot "manual-link"
          if (Test-Path $libManualRoot) { $linkPaths += $libManualRoot }
          $linkFlags = ($linkPaths | ForEach-Object { "/LIBPATH:`"$_`"" }) -join ' '
          $env:LINK = "$linkFlags $env:LINK"

          if (Test-Path $binRoot) { $env:Path = "$binRoot;$env:Path" }

          $buildScript = Join-Path $env:GITHUB_WORKSPACE "build.ps1"
          if (-not (Test-Path $buildScript)) { throw "build.ps1 not found at: $buildScript" }

          & $buildScript -Configuration "${{ inputs.configuration }}" -Platform "${{ inputs.platform }}"

      - name: Upload build output
        if: ${{ inputs.upload_build_output }}
        uses: actions/upload-artifact@v4
        with:
          name: build-output-${{ inputs.platform }}
          path: .build/${{ inputs.platform }}/${{ inputs.configuration }}/
          retention-days: 1
